---
- hosts: localhost
  connection: local
  gather_facts: False
  tasks:
    - name: Provision a set of instances
      ec2:
         key_name: knife_access
         instance_type: t2.micro
         region: us-west-2
         image: ami-9abea4fb
         group_id: sg-e6e72183
         wait: true
         exact_count: 1
         count_tag:
            Name: elasticsearch
         instance_tags:
            Name: elasticsearch
      register: ec2
      tags:
        - ec2-launch

    - name: Add all instance public IPs to host group
      add_host: hostname={{ item.public_ip }} groups=ec2hosts
      with_items: ec2.instances
      tags:
        - ec2-launch

    - name: Wait for SSH
      wait_for: host={{ item.public_dns_name }} port=22 delay=20 timeout=320 state=started
      with_items: ec2.instances
      tags:
        - ec2-launch

- hosts: ec2hosts
  name: Install Java JDK 1.8.0_91
  user: ubuntu
  gather_facts: true
  tasks:
    - name: Download Java from Oracle
      # get_url: url=http://download.oracle.com/otn-pub/java/jdk/8u91-b14/jdk-8u91-linux-x64.tar.gz dest=/tmp headers="oraclelicense:accept-securebackup-cookie"
      command: "wget -q -O /tmp/jdk-8u91-linux-x64.tar.gz --no-check-certificate --no-cookies --header 'Cookie: oraclelicense=accept-securebackup-cookie' http://download.oracle.com/otn-pub/java/jdk/8u91-b14/jdk-8u91-linux-x64.tar.gz creates=/tmp/jdk-8u91-linux-x64.tar.gz"
      tags:
        - java


    - name: Extract to /usr/bin/jdk1.8.0_91
      unarchive: src=/tmp/jdk-8u91-linux-x64.tar.gz dest=/usr/bin copy=no
      sudo: yes
      tags:
        - java

- hosts: ec2hosts
  name: Install Elasticsearch
  user: ubuntu
  gather_facts: true
  tasks:
    - name: Download Elasticsearch onto target machines
      get_url: url="https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.3.3/elasticsearch-2.3.3.tar.gz" dest="/tmp/elasticsearch-2.3.3.tar.gz" validate_certs=no
      tags:
        - elasticsearch

    - name: Extract to the /bin directory
      unarchive: src="/tmp/elasticsearch-2.3.3.tar.gz" dest="/usr/bin" copy=no
      sudo: yes
      tags:
        - elasticsearch
